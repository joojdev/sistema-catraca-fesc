<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.8;
            font-size: 1.1rem;
        }

        .auth-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .content {
            padding: 30px;
            display: none;
        }

        .content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        input[type="password"], input[type="text"] {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input[type="password"]:focus, input[type="text"]:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .btn-success {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #138496);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .action-card {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }

        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .action-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .action-card p {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin: 10px 0;
            display: inline-block;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #b6d4fe;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .data-section {
            margin-top: 30px;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
        }

        .data-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .data-header h3 {
            color: #2c3e50;
            margin: 0;
        }

        .data-count {
            background: #3498db;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: 600;
        }

        .data-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .table-container {
            max-height: 400px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .icon {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        .rate-limit-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .rate-limit-info strong {
            display: block;
            margin-bottom: 5px;
        }

        @media (max-width: 768px) {
            .actions-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .container {
                margin: 10px;
                border-radius: 15px;
            }
        }

        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .confirm-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 400px;
            text-align: center;
        }

        .confirm-content h3 {
            color: #e74c3c;
            margin-bottom: 15px;
        }

        .confirm-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ†Ô∏è Painel Administrativo</h1>
            <p>Sistema de Gerenciamento e Monitoramento</p>
        </div>

        <div class="auth-section">
            <div class="form-group">
                <label for="adminToken">Token Administrativo:</label>
                <input type="password" id="adminToken" placeholder="Insira o token de acesso" />
            </div>
            <button class="btn btn-primary" onclick="authenticate()" id="authBtn">
                <svg class="icon" viewBox="0 0 24 24"><path d="M12,17A2,2 0 0,0 14,15C14,13.89 13.1,13 12,13A2,2 0 0,0 10,15A2,2 0 0,0 12,17M18,8A2,2 0 0,1 20,10V20A2,2 0 0,1 18,22H6A2,2 0 0,1 4,20V10C4,8.89 4.9,8 6,8H7V6A5,5 0 0,1 12,1A5,5 0 0,1 17,6V8H18M12,3A3,3 0 0,0 9,6V8H15V6A3,3 0 0,0 12,3Z" /></svg>
                Autenticar
            </button>
        </div>

        <div class="content" id="mainContent">
            <div class="actions-grid">
                <div class="action-card">
                    <h3>üîÑ Importa√ß√£o Manual</h3>
                    <p>Executa o processo de importa√ß√£o imediatamente, fora do agendamento autom√°tico.</p>
                    <button class="btn btn-success" onclick="triggerImport()">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M5,20H19V18H5M19,9H15L13,7H9V9H5L12,16L19,9Z" /></svg>
                        Executar Importa√ß√£o
                    </button>
                </div>

                <div class="action-card">
                    <h3>üìä Listar Acessos</h3>
                    <p>Visualiza todos os registros de acesso ao sistema para auditoria.</p>
                    <button class="btn btn-info" onclick="listAccesses()">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M9,5V9H21V5M9,19H21V15H9M9,14H21V10H9M4,9H8L6,7L4,9M4,19H8L6,17L4,19M4,14H8L6,12L4,14Z" /></svg>
                        Ver Acessos
                    </button>
                </div>

                <div class="action-card">
                    <h3>üìö Listar Aulas</h3>
                    <p>Exibe todos os hor√°rios de aulas cadastrados no sistema.</p>
                    <button class="btn btn-info" onclick="listClasses()">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M19,3H5C3.9,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V5C21,3.9 20.1,3 19,3M19,19H5V8H19V19Z" /></svg>
                        Ver Aulas
                    </button>
                </div>

                <div class="action-card">
                    <h3>üè∑Ô∏è Listar Tags</h3>
                    <p>Mostra todas as tags/credenciais registradas no banco de dados.</p>
                    <button class="btn btn-info" onclick="listTags()">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M5.5,7A1.5,1.5 0 0,1 4,5.5A1.5,1.5 0 0,1 5.5,4A1.5,1.5 0 0,1 7,5.5A1.5,1.5 0 0,1 5.5,7M21.41,11.58L12.41,2.58C12.05,2.22 11.55,2 11,2H4C2.9,2 2,2.9 2,4V11C2,11.55 2.22,12.05 2.59,12.41L11.58,21.41C11.95,21.78 12.45,22 13,22C13.55,22 14.05,21.78 14.41,21.41L21.41,14.41C21.78,14.05 22,13.55 22,13C22,12.45 21.78,11.95 21.41,11.58Z" /></svg>
                        Ver Tags
                    </button>
                </div>

                <div class="action-card">
                    <h3>ü©∫ Health Check</h3>
                    <p>Verifica o status atual do sistema e informa√ß√µes de sa√∫de.</p>
                    <button class="btn btn-primary" onclick="healthCheck()">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M11,16.5L6.5,12L7.91,10.59L11,13.67L16.59,8.09L18,9.5L11,16.5Z" /></svg>
                        Verificar Sistema
                    </button>
                </div>

                <div class="action-card">
                    <h3>‚ö†Ô∏è Limpar Banco</h3>
                    <p>CUIDADO: Remove TODOS os dados do sistema. Esta a√ß√£o √© irrevers√≠vel!</p>
                    <button class="btn btn-danger" onclick="confirmEraseEverything()">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" /></svg>
                        Limpar Tudo
                    </button>
                </div>
            </div>

            <div id="statusMessages"></div>
            <div id="dataDisplay"></div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o -->
    <div class="confirm-dialog" id="confirmDialog">
        <div class="confirm-content">
            <h3>‚ö†Ô∏è Confirma√ß√£o Necess√°ria</h3>
            <p>Tem certeza que deseja apagar TODOS os dados do sistema?</p>
            <p><strong>Esta a√ß√£o n√£o pode ser desfeita!</strong></p>
            <div class="confirm-buttons">
                <button class="btn btn-danger" onclick="eraseEverything()">Sim, Apagar Tudo</button>
                <button class="btn btn-primary" onclick="closeConfirmDialog()">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        let currentToken = '';
        let isAuthenticated = false;
        const SESSION_KEY = 'admin_session';
        const TOKEN_KEY = 'admin_token_validated';

        // Verifica se h√° sess√£o v√°lida ao carregar a p√°gina
        window.addEventListener('load', function() {
            checkExistingSession();
        });

        function checkExistingSession() {
            try {
                const savedSession = sessionStorage.getItem(SESSION_KEY);
                const savedToken = sessionStorage.getItem(TOKEN_KEY);
                
                if (savedSession && savedToken) {
                    const session = JSON.parse(savedSession);
                    
                    // Verifica se a sess√£o n√£o expirou (v√°lida por 1 hora)
                    if (session.expiry > Date.now()) {
                        currentToken = savedToken;
                        isAuthenticated = true;
                        document.querySelector('.content').classList.add('active');
                        document.getElementById('adminToken').value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                        
                        const timeLeft = Math.round((session.expiry - Date.now()) / 1000 / 60);
                        showMessage(`üîì Sess√£o restaurada! Expira em ${timeLeft} minutos.`, 'success');
                        addLogoutButton();
                        return;
                    } else {
                        // Sess√£o expirou
                        clearSession();
                        showMessage('‚è∞ Sess√£o expirou. Fa√ßa login novamente.', 'warning');
                    }
                }
            } catch (error) {
                console.error('Erro ao verificar sess√£o:', error);
                clearSession();
            }
        }

        function saveSession() {
            try {
                const session = {
                    authenticated: true,
                    timestamp: Date.now(),
                    expiry: Date.now() + (60 * 60 * 1000) // 1 hora
                };
                
                sessionStorage.setItem(SESSION_KEY, JSON.stringify(session));
                sessionStorage.setItem(TOKEN_KEY, currentToken);
            } catch (error) {
                console.error('Erro ao salvar sess√£o:', error);
            }
        }

        function clearSession() {
            try {
                sessionStorage.removeItem(SESSION_KEY);
                sessionStorage.removeItem(TOKEN_KEY);
                isAuthenticated = false;
                currentToken = '';
                document.querySelector('.content').classList.remove('active');
                document.getElementById('adminToken').value = '';
            } catch (error) {
                console.error('Erro ao limpar sess√£o:', error);
            }
        }

        async function authenticate() {
            const tokenInput = document.getElementById('adminToken');
            const token = tokenInput.value;
            const authBtn = document.getElementById('authBtn');
            
            // Verifica se j√° est√° autenticado
            if (isAuthenticated) {
                showMessage('‚úÖ Voc√™ j√° est√° autenticado!', 'info');
                return;
            }
            
            if (!token.trim()) {
                showMessage('‚ùå Por favor, insira o token administrativo', 'error');
                tokenInput.focus();
                return;
            }

            // N√£o permite tokens muito curtos (seguran√ßa b√°sica)
            if (token.length < 8) {
                showMessage('‚ùå Token deve ter pelo menos 8 caracteres', 'error');
                tokenInput.focus();
                return;
            }
            
            authBtn.disabled = true;
            authBtn.innerHTML = '<div class="spinner"></div> Verificando token...';
            
            try {
                const response = await fetch('/verify-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ Token: token })
                });
                
                const data = await response.json();
                
                if (response.status === 429) {
                    showMessage(`‚è∞ ${data.message} Aguarde ${data.retryAfter} minutos para tentar novamente.`, 'warning');
                    return;
                }
                
                if (response.status === 401 || response.status === 400) {
                    showMessage('üîí Token inv√°lido! Verifique o token e tente novamente.', 'error');
                    tokenInput.value = '';
                    tokenInput.focus();
                    return;
                }

                if (!response.ok) {
                    throw new Error(`Erro ${response.status}: ${data.message || 'Falha na verifica√ß√£o'}`);
                }
                
                if (data.valid && data.success) {
                    currentToken = token;
                    isAuthenticated = true;
                    saveSession(); // Salva a sess√£o
                    
                    document.querySelector('.content').classList.add('active');
                    tokenInput.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'; // Mascara o token
                    
                    showMessage('‚úÖ Token v√°lido! Autentica√ß√£o realizada com sucesso.', 'success');
                    
                    // Adiciona bot√£o de logout
                    addLogoutButton();
                } else {
                    showMessage('‚ùå Token inv√°lido! Verifique as credenciais.', 'error');
                    tokenInput.value = '';
                    tokenInput.focus();
                }
                
            } catch (error) {
                console.error('Erro na autentica√ß√£o:', error);
                showMessage(`‚ùå Erro de conex√£o: ${error.message}`, 'error');
                tokenInput.focus();
            } finally {
                authBtn.disabled = false;
                authBtn.innerHTML = `
                    <svg class="icon" viewBox="0 0 24 24"><path d="M12,17A2,2 0 0,0 14,15C14,13.89 13.1,13 12,13A2,2 0 0,0 10,15A2,2 0 0,0 12,17M18,8A2,2 0 0,1 20,10V20A2,2 0 0,1 18,22H6A2,2 0 0,1 4,20V10C4,8.89 4.9,8 6,8H7V6A5,5 0 0,1 12,1A5,5 0 0,1 17,6V8H18M12,3A3,3 0 0,0 9,6V8H15V6A3,3 0 0,0 12,3Z" /></svg>
                    Autenticar
                `;
            }
        }

        function addLogoutButton() {
            const authSection = document.querySelector('.auth-section');
            
            // Remove bot√£o de logout existente se houver
            const existingLogout = document.getElementById('logoutBtn');
            if (existingLogout) {
                existingLogout.remove();
            }
            
            const logoutBtn = document.createElement('button');
            logoutBtn.id = 'logoutBtn';
            logoutBtn.className = 'btn btn-warning';
            logoutBtn.style.marginLeft = '10px';
            logoutBtn.innerHTML = `
                <svg class="icon" viewBox="0 0 24 24"><path d="M16,17V14H9V10H16V7L21,12L16,17M14,2A2,2 0 0,1 16,4V6H14V4H5V20H14V18H16V20A2,2 0 0,1 14,22H5A2,2 0 0,1 3,20V4A2,2 0 0,1 5,2H14Z" /></svg>
                Sair
            `;
            logoutBtn.onclick = logout;
            
            authSection.appendChild(logoutBtn);
        }

        function logout() {
            if (confirm('Tem certeza que deseja sair? Voc√™ precisar√° inserir o token novamente.')) {
                clearSession();
                document.getElementById('dataDisplay').innerHTML = '';
                document.getElementById('statusMessages').innerHTML = '';
                
                const logoutBtn = document.getElementById('logoutBtn');
                if (logoutBtn) {
                    logoutBtn.remove();
                }
                
                showMessage('üëã Logout realizado com sucesso!', 'info');
                document.getElementById('adminToken').focus();
            }
        }

        function showMessage(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessages');
            const messageElement = document.createElement('div');
            messageElement.className = `status ${type}`;
            messageElement.innerHTML = message;
            
            statusDiv.innerHTML = '';
            statusDiv.appendChild(messageElement);
            
            setTimeout(() => {
                if (messageElement.parentNode) {
                    messageElement.remove();
                }
            }, type === 'warning' ? 10000 : 8000); // Warnings ficam mais tempo
        }

        function showLoading(text = 'Carregando...') {
            const statusDiv = document.getElementById('statusMessages');
            statusDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    ${text}
                </div>
            `;
        }

        async function makeRequest(endpoint, showLoadingText = 'Processando...') {
            if (!isAuthenticated || !currentToken) {
                showMessage('‚ùå Voc√™ n√£o est√° autenticado. Fa√ßa login primeiro.', 'error');
                return null;
            }

            // Verifica se a sess√£o ainda √© v√°lida
            const savedSession = sessionStorage.getItem(SESSION_KEY);
            if (savedSession) {
                const session = JSON.parse(savedSession);
                if (session.expiry <= Date.now()) {
                    logout();
                    showMessage('‚è∞ Sess√£o expirou. Fa√ßa login novamente.', 'warning');
                    return null;
                }
            }

            showLoading(showLoadingText);

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ Token: currentToken })
                });

                const data = await response.json();

                if (response.status === 429) {
                    showMessage(`‚è∞ ${data.message} Aguarde ${data.retryAfter} minutos para nova tentativa.`, 'warning');
                    return null;
                }

                if (!response.ok) {
                    if (response.status === 401) {
                        logout();
                        showMessage('üîí Sess√£o expirou ou token inv√°lido. Fa√ßa login novamente.', 'error');
                        return null;
                    }
                    showMessage(`‚ùå Erro ${response.status}: ${data.message || 'Opera√ß√£o falhou'}`, 'error');
                    return null;
                }

                return data;
            } catch (error) {
                console.error('Erro na requisi√ß√£o:', error);
                showMessage(`‚ùå Erro de conex√£o: ${error.message}`, 'error');
                return null;
            }
        }

        async function triggerImport() {
            const result = await makeRequest('/api/trigger-import', 'Executando importa√ß√£o...');
            if (result) {
                showMessage(`‚úÖ ${result.message} Conclu√≠da em ${new Date(result.timestamp).toLocaleString('pt-BR')}`, 'success');
            }
        }

        async function listAccesses() {
            const result = await makeRequest('/api/list-accesses', 'Buscando registros de acesso...');
            if (result) {
                displayData('Registros de Acesso', result.data, result.count);
                showMessage(`üìä ${result.count} registros de acesso encontrados`, 'info');
            }
        }

        async function listClasses() {
            const result = await makeRequest('/api/list-classes', 'Buscando hor√°rios de aulas...');
            if (result) {
                displayData('Hor√°rios de Aulas', result.data, result.count);
                showMessage(`üìö ${result.count} hor√°rios de aula encontrados`, 'info');
            }
        }

        async function listTags() {
            const result = await makeRequest('/api/list-tags', 'Buscando tags/credenciais...');
            if (result) {
                displayData('Tags/Credenciais', result.data, result.count);
                showMessage(`üè∑Ô∏è ${result.count} tags/credenciais encontradas`, 'info');
            }
        }

        async function healthCheck() {
            showLoading('Verificando status do sistema...');
            try {
                const response = await fetch('/health');
                
                if (!response.ok) {
                    throw new Error(`Status ${response.status}`);
                }
                
                const data = await response.json();
                const uptime = Math.floor(data.uptime / 60);
                const uptimeHours = Math.floor(uptime / 60);
                const uptimeMinutes = uptime % 60;
                
                let uptimeText = '';
                if (uptimeHours > 0) {
                    uptimeText = `${uptimeHours}h ${uptimeMinutes}min`;
                } else {
                    uptimeText = `${uptimeMinutes}min`;
                }
                
                showMessage(`‚úÖ Sistema operacional! Uptime: ${uptimeText} | Vers√£o: ${data.version || 'N/A'}`, 'success');
                
            } catch (error) {
                console.error('Erro no health check:', error);
                showMessage(`‚ùå Erro ao verificar sistema: ${error.message}`, 'error');
            }
        }

        function confirmEraseEverything() {
            if (!isAuthenticated) {
                showMessage('‚ùå Voc√™ precisa estar autenticado para esta opera√ß√£o.', 'error');
                return;
            }
            document.getElementById('confirmDialog').style.display = 'flex';
        }

        function closeConfirmDialog() {
            document.getElementById('confirmDialog').style.display = 'none';
        }

        async function eraseEverything() {
            closeConfirmDialog();
            const result = await makeRequest('/api/erase-everything', 'üóëÔ∏è Apagando todos os dados...');
            if (result) {
                document.getElementById('dataDisplay').innerHTML = '';
                showMessage(`üóëÔ∏è ${result.message} Opera√ß√£o conclu√≠da em ${new Date(result.timestamp).toLocaleString('pt-BR')}`, 'success');
            }
        }

        function displayData(title, data, count) {
            const dataDiv = document.getElementById('dataDisplay');
            
            if (!data || data.length === 0) {
                dataDiv.innerHTML = `
                    <div class="data-section">
                        <div class="data-header">
                            <h3>${title}</h3>
                            <span class="data-count">0</span>
                        </div>
                        <p style="text-align: center; color: #666; padding: 20px;">
                            üì≠ Nenhum registro encontrado
                        </p>
                    </div>
                `;
                return;
            }

            const keys = Object.keys(data[0]);
            const tableHeaders = keys.map(key => `<th>${key}</th>`).join('');
            const tableRows = data.map((item, index) => {
                const cells = keys.map(key => {
                    let value = item[key];
                    
                    // Formata√ß√£o especial para diferentes tipos
                    if (value === null || value === undefined) {
                        value = '-';
                    } else if (typeof value === 'string' && value.includes('T') && value.includes('Z')) {
                        // Formatar datas ISO
                        try {
                            value = new Date(value).toLocaleString('pt-BR');
                        } catch (e) {
                            // Mant√©m valor original se n√£o conseguir formatar
                        }
                    } else if (typeof value === 'boolean') {
                        value = value ? '‚úÖ' : '‚ùå';
                    } else if (typeof value === 'number') {
                        value = value.toLocaleString('pt-BR');
                    }
                    
                    return `<td>${value}</td>`;
                }).join('');
                return `<tr>${cells}</tr>`;
            }).join('');

            dataDiv.innerHTML = `
                <div class="data-section">
                    <div class="data-header">
                        <h3>${title}</h3>
                        <span class="data-count">${count}</span>
                    </div>
                    <div class="data-table">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>${tableHeaders}</tr>
                                </thead>
                                <tbody>
                                    ${tableRows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <p style="text-align: center; color: #666; font-size: 12px; margin-top: 10px;">
                        √öltima atualiza√ß√£o: ${new Date().toLocaleString('pt-BR')}
                    </p>
                </div>
            `;
        }

        // Atalhos de teclado melhorados
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + tecla
            if (e.ctrlKey || e.metaKey) {
                switch(e.key.toLowerCase()) {
                    case 'i':
                        e.preventDefault();
                        if (isAuthenticated) triggerImport();
                        break;
                    case 'h':
                        e.preventDefault();
                        healthCheck();
                        break;
                    case 'l':
                        e.preventDefault();
                        if (isAuthenticated) logout();
                        break;
                }
            }
            
            // ESC para fechar modal
            if (e.key === 'Escape') {
                closeConfirmDialog();
            }
        });

        // Enter no campo de token
        document.getElementById('adminToken').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                authenticate();
            }
        });

        // Monitora mudan√ßas no campo de token
        document.getElementById('adminToken').addEventListener('input', function(e) {
            const token = e.target.value;
            if (token && !token.includes('‚Ä¢')) {
                // Token foi alterado, limpa a autentica√ß√£o
                if (isAuthenticated) {
                    clearSession();
                    const logoutBtn = document.getElementById('logoutBtn');
                    if (logoutBtn) logoutBtn.remove();
                    showMessage('üîÑ Token alterado. Fa√ßa nova autentica√ß√£o.', 'info');
                }
            }
        });

        // Auto-focus no campo de token ao carregar
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const tokenInput = document.getElementById('adminToken');
                if (tokenInput && !isAuthenticated) {
                    tokenInput.focus();
                }
            }, 100);
        });

        // Aviso antes de fechar a p√°gina se estiver autenticado
        window.addEventListener('beforeunload', function(e) {
            if (isAuthenticated) {
                const message = 'Voc√™ tem uma sess√£o ativa. Tem certeza que deseja sair?';
                e.returnValue = message;
                return message;
            }
        });
    </script>
</body>
</html>
